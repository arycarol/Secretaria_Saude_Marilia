<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Motorista</title>
  <link rel="stylesheet" href="painel_motorista.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <div id="app">

    <div 
        :class="{ 'sidebar': true, 'active': isSidebarActive }"
        @mouseover="isSidebarActive = true"
        @mouseleave="isSidebarActive = false"
    >
        <div class="logo">
            <img src="./img/logomenu.png" alt="Logo C+M" class="logo-image">
        </div>

        <p class="section-title">Funcionalidades</p>

        <div class="menu">
            <a href="#" class="active">
                <i class="fas fa-car"></i>
                <span>Painel do Motorista</span>
            </a>

            <a href="../meu perfil/perfil.html">
                <i class="fas fa-user-circle"></i>
                <span>Meu Perfil</span>
            </a>
            
            </div>
    </div>
    <button 
        :class="{ 'menu-toggle': true, 'active': isSidebarActive }"
        @mouseover="isSidebarActive = true"
        @mouseleave="isSidebarActive = false"
    >
        <i :class="isSidebarActive ? 'fas fa-chevron-left' : 'fas fa-bars'"></i>
    </button>
    <div class="container">

      <main class="content">

        <div class="main-header">
            <div class="title-area">
                <img src="./img/driver.png.png" alt="Ícone de Carro" class="vehicle-icon-img" style="width: 50px; height: 50px;">
                
                <div>
                    <h1 class="main-title-line">Painel do Motorista</h1>
                    <h1 class="title-highlight">Solicitações e Agenda</h1>
                </div>
            </div>
            
            <div class="user-profile">
                <a href="../login/login.html" class="action-icon">
                    <img src="./img/back.png" alt="Sair" class="icon-back">
                </a>
                <a href="../meu perfil/perfil.html" class="action-icon">
                    <img src="./img/profile.png" alt="Meu Perfil" class="icon-profile">
                </a>
            </div>
        </div>
        <section class="painel-motorista">
          <div class="topo-grid">

            <div class="status-veiculo">
              <h2>STATUS DO VEÍCULO</h2>

              <div class="box-info">
                <p><strong>PLACA:</strong> ABC-123</p>
                <p><strong>MODELO:</strong> LANCER 2018</p>
                <p><strong>COMBUSTÍVEL:</strong> GASOLINA / ÁLCOOL</p>
              </div>

              <div class="solicitacoes">
                <h2>SOLICITAÇÕES <i class="fa-solid fa-triangle-exclamation alerta"></i></h2>
                <div class="lista-solicitacoes"></div>
              </div>

              <div class="solicitacoes">
                <h2>SOLICITAÇÕES ACEITAS <i class="fa-solid fa-circle-check sucesso"></i></h2>
                <div class="lista-aceitas"></div>
              </div>

            </div>

            <div class="agenda-dia">
              <h2>AGENDA DO DIA</h2>
              <div class="lista-agenda"></div>
            </div>

          </div>
        </section>

        <div class="legenda-status">
          <span><span class="bolinha ainda"></span> Ainda hoje</span>
        </div>

        <div class="modal-confirmacao" id="modalConfirmacao">
          <div class="modal-conteudo">
            <i class="fa-solid fa-check"></i>
            <p><strong>Solicitação aceita<br><span class="sucesso">com sucesso!</span></strong></p>
          </div>
        </div>

      </main>

    </div>
  </div>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>

const app = Vue.createApp({
    data() {
        return {
            isSidebarActive: false,
        };
    }
});

app.mount("#app");

function getCookie(name) {
  const cookies = document.cookie.split(";").map(c => c.trim());
  for (const cookie of cookies) {
      if (cookie.startsWith(name + "=")) {
          return cookie.substring(name.length + 1);
      }
  }
  return null;
}

const token = null;
const driverUserId = null;

if (!token || !driverUserId) {
  alert("Sessão expirada. Faça login novamente.");
  window.location.href = "../login/login.html";
}

const API_BASE = "https://localhost:7041/api/v1";

const solicitacoesContainer = document.querySelector(".lista-solicitacoes");
const aceitasContainer = document.querySelector(".lista-aceitas");
const agendaContainer = document.querySelector(".lista-agenda");

async function carregarAssignments() {
  try {
      const response = await fetch(`${API_BASE}/TransportAssignment/GetListByDriverId/${driverUserId}`, {
          headers: { "Authorization": `Bearer ${token}` }
      });

      if (!response.ok) throw new Error("Erro ao carregar assignments");

      const assignments = await response.json();

      solicitacoesContainer.innerHTML = "";
      aceitasContainer.innerHTML = "";

      for (const item of assignments) {

          const paciente = await carregarPaciente(item.pacientUserId);
          const request = await carregarRequest(item.transportRequestId);

          if (item.transportAssignmentStatus === "Aguardando") {
              adicionarSolicitacaoPendente(
                  item.id,
                  request.hour,
                  paciente.name,
                  paciente.cpf,
                  request.transportKind,
                  request.originLocation,
                  request.destinationLocation
              );
          }

          if (item.transportAssignmentStatus === "Concluido" ||
              item.transportAssignmentStatus === "Aceito") {
              adicionarSolicitacaoAceita(
                  request.hour,
                  paciente.name,
                  paciente.cpf,
                  request.transportKind,
                  request.originLocation,
                  request.destinationLocation
              );
          }
      }

  } catch (err) {
      console.error(err);
  }
  solicitacoesContainer.innerHTML = `<p class="mensagem-vazia">Nenhuma solicitação (API desativada).</p>`;
  aceitasContainer.innerHTML = `<p class="mensagem-vazia">Nenhuma solicitação aceita (API desativada).</p>`;
}

async function carregarAgenda() {
  try {
      const response = await fetch(`${API_BASE}/TransportAssignment/GetListOfToday/${driverUserId}`, {
          headers: { "Authorization": `Bearer ${token}` }
      });

      if (!response.ok) throw new Error("Erro ao carregar agenda");

      const assignments = await response.json();

      agendaContainer.innerHTML = "";

      const concluidos = assignments.filter(a =>
          a.transportAssignmentStatus.toLowerCase() === "concluido"
      );

      for (const item of concluidos) {
          const paciente = await carregarPaciente(item.pacientUserId);
          const request = await carregarRequest(item.transportRequestId);

          adicionarAgenda(
              request.hour,
              paciente.name,
              paciente.cpf,
              request.transportKind,
              request.originLocation,
              request.destinationLocation
          );
      }

  } catch (err) {
      console.error(err);
  }

  agendaContainer.innerHTML = `<p class="mensagem-vazia">Nenhuma agenda (API desativada).</p>`;
}

async function carregarPaciente(id) {
  const res = await fetch(`${API_BASE}/User/${id}`, {
      headers: { "Authorization": `Bearer ${token}` }
  });
  return await res.json();
}

async function carregarRequest(id) {
  const res = await fetch(`${API_BASE}/TransportRequest/${id}`, {
      headers: { "Authorization": `Bearer ${token}` }
  });
  return await res.json();
}

function adicionarSolicitacaoPendente(id, hora, nome, cpf, tipoAtendimento, origem, destino) {
  const div = document.createElement("div");
  div.classList.add("box-info");

  div.innerHTML = `
      <p><strong>${hora} - ${nome} - CPF: ${cpf}</strong></p>

      <p><strong>TIPO:</strong> ${tipoAtendimento}</p>

      <p><strong>PARTIDA:</strong> ${origem}</p>
      <p><strong>DESTINO:</strong> ${destino}</p>

      <div class="botoes">
        <button class="btn-recusar">RECUSAR</button>
        <button class="btn-aceitar">ACEITAR</button>
      </div>
  `;
   div.querySelector(".btn-aceitar")
      .addEventListener("click", () => aceitarSolicitacao(id, div));

  solicitacoesContainer.appendChild(div);
}

function adicionarSolicitacaoAceita(hora, nome, cpf, tipoAtendimento, origem, destino) {
  const div = document.createElement("div");
  div.classList.add("box-info");

  div.innerHTML = `
      <p><strong>${hora} - ${nome} - CPF: ${cpf}</strong></p>

      <p><strong>TIPO:</strong> ${tipoAtendimento}</p>

      <p><strong>PARTIDA:</strong> ${origem}</p>
      <p><strong>DESTINO:</strong> ${destino}</p>
  `;

  aceitasContainer.appendChild(div);
}

function adicionarAgenda(hora, nome, cpf, tipoAtendimento, origem, destino) {
  const div = document.createElement("div");
  div.classList.add("box-agenda");

  div.innerHTML = `
      <p><strong>${hora} - ${nome} - CPF: ${cpf}</strong></p>

      <p><strong>TIPO:</strong> ${tipoAtendimento}</p>

      <p><strong>PARTIDA:</strong> ${origem}</p>
      <p><strong>DESTINO:</strong> ${destino}</p>

      <span class="status-bolinha ainda"></span>
  `;

  agendaContainer.appendChild(div);
}

async function aceitarSolicitacao(id, elemento) {
  try {
      const response = await fetch(`${API_BASE}/TransportAssignment/Accept/${id}`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}` }
      });

      if (!response.ok) throw new Error("Erro ao aceitar solicitação");

      elemento.remove();
      mostrarModal();
      carregarAssignments();
      carregarAgenda();

  } catch (err) {
      console.error(err);
  }
}

function mostrarModal() {
  const modal = document.getElementById("modalConfirmacao");
  modal.classList.add("ativo");
  setTimeout(() => modal.classList.remove("ativo"), 1800);
}

carregarAssignments();
carregarAgenda();


</script>

</body>
</html>