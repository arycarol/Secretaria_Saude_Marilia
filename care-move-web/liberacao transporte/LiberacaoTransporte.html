<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Liberação de Transporte</title>
    <link rel="stylesheet" href="./LiberacaoTransporte.css" /> 
    <link rel="stylesheet" 
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>

<div id="app" class="app-container">

    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <img src="./img/logomenu.png" alt="Logo C+M" class="logo-image">
        </div>
        <p class="section-title">Funcionalidades</p>
        <nav class="menu">
            <a href="../painel adm/index.html" class="menu-item"><i class="fa-solid fa-user"></i> <span>Gerenciamento de Usuários</span></a>

            <a href="#" class="menu-item active">
                <i class="fa-solid fa-van-shuttle"></i> <span>Liberação de Transporte e Agendamento</span>
            </a>

            <a href="../controle de frota/frota.html" class="menu-item"><i class="fa-solid fa-truck"></i> <span>Controle de Frotas</span></a>

            <a href="../meu perfil/perfil.html" class="menu-item"><i class="fa-solid fa-circle-user"></i> <span>Meu Perfil</span></a>
        </nav>
    </aside>

    <button class="menu-toggle" id="menu-toggle">
        <i class="fas fa-bars" id="toggle-icon"></i>
    </button>
    
    <main class="main-content" id="main-content">
        
        <header class="main-header">
            <div class="title-area">
                <i class="fas fa-car" style="font-size: 50px; color: var(--primary-color); margin-right: 15px;"></i>
                <div>
                    <h1 class="main-title-line">Painel Administrativo</h1>
                    <h1 class="title-highlight">Liberação de Transporte e Agendamento</h1>
                </div>
            </div>
            <div class="user-profile"> 
                <a href="../login/login.html" class="action-icon">
                    <img src="./img/back.png" alt="Sair" class="icon-back">
                </a>
                <a href="../meu perfil/perfil.html" class="action-icon">
                    <img src="./img/profile.png" alt="Meu Perfil" class="icon-profile">
                </a>
            </div>
        </header>

        <div class="top-controls-row" style="justify-content: flex-start;">
            <div class="control-row-outside">
                <div class="tabs-group">
                    <button class="tab-button active" data-tab="pendente">Pendentes</button>
                    <button class="tab-button" data-tab="aprovado">Aprovados/Bloqueados</button>
                </div>
                
                <div class="search-input-group-outside">
                    <i class="fas fa-search search-icon-outside"></i>
                    <input type="text" placeholder="Pesquisar SC ou Local" id="search-input"/>
                </div>
            </div>
        </div>

        <div class="fleet-table-header">
            <div class="table-header-row transport-grid">
                <span class="header-col column-sc-number">SC</span>
                <span class="header-col column-local">Local</span>
                <span class="header-col column-data">Data/Hora</span>
                <span class="header-col column-tipo">Tipo</span>
                <span class="header-col column-actions">Ações</span>
            </div>
        </div>

        <div class="fleet-control-panel">
            <div class="table-body" id="data-rows-container">
                </div>
        </div>
        
        <p class="record-count-outside" id="record-count">00 Registros</p>

        <div class="status-legend">
            <div class="legend-item"><span class="status-dot blue"></span> Aguardando</div>
            <div class="legend-item"><span class="status-dot green"></span> Aprovado</div>
            <div class="legend-item"><span class="status-dot black"></span> Negado</div>
            <div class="legend-item"><span class="status-dot red"></span> Concluído</div>
        </div>
    </main>
    
    <div class="modal-overlay success-modal-overlay" id="status-modal">
        <div class="modal-content success-modal-content">
            <i class="fas fa-times success-close-button" id="modal-close"></i>
            <div class="modal-icon-container" id="modal-icon-container"></div>
            <h2 class="success-title" id="modal-text"></h2>
        </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // --------------------------
    // UI ELEMENTS / SIDEBAR LOGIC
    // --------------------------
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.getElementById("menu-toggle");
    const toggleIcon = document.getElementById("toggle-icon");
    const mainContent = document.getElementById("main-content");
    
    let isSidebarLocked = false; 
    
    function updateSidebarState(lock = null) {
        if (lock !== null) isSidebarLocked = lock;
        const shouldBeActive = isSidebarLocked || sidebar.matches(':hover') || menuToggle.matches(':hover');
        sidebar.classList.toggle("active", shouldBeActive);
        mainContent.classList.toggle("shifted", shouldBeActive); 
        toggleIcon.classList.remove("fa-bars", "fa-chevron-left");
        toggleIcon.classList.add(isSidebarLocked ? "fa-chevron-left" : "fa-bars");
        menuToggle.classList.toggle("locked", isSidebarLocked);
    }
    
    menuToggle.addEventListener("click", () => updateSidebarState(!isSidebarLocked));
    menuToggle.addEventListener("mouseenter", () => {
        if (!isSidebarLocked) { sidebar.classList.add("active"); mainContent.classList.add("shifted"); }
    });
    function handleMouseLeave() {
        setTimeout(() => {
            if (!isSidebarLocked && !sidebar.matches(':hover') && !menuToggle.matches(':hover')) {
                sidebar.classList.remove("active");
                mainContent.classList.remove("shifted");
            }
        }, 50);
    }
    menuToggle.addEventListener("mouseleave", handleMouseLeave);
    sidebar.addEventListener("mouseleave", handleMouseLeave);
    sidebar.addEventListener("mouseenter", () => {
        if (!isSidebarLocked) { sidebar.classList.add("active"); mainContent.classList.add("shifted"); }
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return null;
    }

    const token = getCookie("jwt");
    const driverId = getCookie("userId");

    if (!token) {
        alert("Você precisa fazer login!");
        window.location.href = "../login/login.html";
        return;
    }

    const tabButtons = document.querySelectorAll(".tab-button");
    const dataRowsContainer = document.getElementById("data-rows-container");
    const recordCount = document.getElementById("record-count");
    const searchInput = document.getElementById("search-input");

    let currentTab = "pendente";

    let pendingList = [];
    let nonPendingList = [];

    const allRequestsFallback = [
        { id: "000001", local: "Santa Casa", data: "19/09/2025", hora: "08:00", tipo: "Exame", status: "Aguardando", statusClass: "blue", motorista: null },
        { id: "000004", local: "UPA", data: "18/09/2025", hora: "14:30", tipo: "Transferência", status: "Aceito", statusClass: "green", motorista: "Motorista Z" },
        { id: "000005", local: "Clínica X", data: "17/09/2025", hora: "11:00", tipo: "Exame", status: "Negado", statusClass: "black", motorista: null }
    ];

    function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        return d.toLocaleDateString("pt-BR");
    }
    function formatHour(hourStr) {
        if (!hourStr) return "";
        // suporta "22:00:00" ou "22:00"
        return hourStr.substring(0,5);
    }

    function mapStatus(apiStatus) {
        const s = (apiStatus || "").toLowerCase();
        if (s === "aguardando") return { status: "Aguardando", class: "blue" };
        if (s === "aceito" || s === "aceito".toLowerCase()) return { status: "Aprovado", class: "green" };
        if (s === "negado") return { status: "Negado", class: "black" };
        if (s === "concluido" || s === "concluído") return { status: "Concluído", class: "red" };
        return { status: apiStatus || "Indefinido", class: "red" };
    }

    async function loadPendingRequests() {
        try {
            const res = await fetch("http://localhost:5260/api/v1/TransportRequest/GetListPending", {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Erro ao obter pendentes: " + res.status);
            const list = await res.json();

            pendingList = list.map(item => {
                const mapped = mapStatus(item.transportStatus);
                return {
                    id: String(item.id).padStart(6, "0"),
                    realId: item.id,
                    local: `${item.originLocation} → ${item.destinationLocation}`,
                    data: formatDate(item.date),
                    hora: formatHour(item.hour),
                    tipo: item.transportKind || "",
                    status: mapped.status,
                    statusClass: mapped.class,
                    motorista: item.driverName ?? null,
                    raw: item
                };
            });

        } catch (err) {
            console.error("loadPendingRequests error:", err);
            pendingList = allRequestsFallback.filter(r => r.status === "Aguardando");
        } finally {
            if (currentTab === "pendente") reloadCurrentTab();
        }
    }

    async function loadNonPendingRequests() {
        try {
            const res = await fetch("http://localhost:5260/api/v1/TransportRequest/GetListNonPending", {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Erro ao obter não-pendentes: " + res.status);
            const list = await res.json();

            nonPendingList = list.map(item => {
                const mapped = mapStatus(item.transportStatus);
                // normalizar texto 'Aceito' -> 'Aprovado' para exibir
                const motorista = item.driverName ?? null;
                return {
                    id: String(item.id).padStart(6, "0"),
                    realId: item.id,
                    local: `${item.originLocation} → ${item.destinationLocation}`,
                    data: formatDate(item.date),
                    hora: formatHour(item.hour),
                    tipo: item.transportKind || "",
                    status: mapped.status,
                    statusClass: mapped.class,
                    motorista,
                    raw: item
                };
            });

        } catch (err) {
            console.error("loadNonPendingRequests error:", err);
            nonPendingList = allRequestsFallback.filter(r => r.status !== "Aguardando");
        } finally {
            if (currentTab === "aprovado") reloadCurrentTab();
        }
    }

    function filterData(tab, query = "") {
        const q = (query || "").toLowerCase();
        const source = tab === "pendente" ? pendingList : nonPendingList;
        if (!q) return source.slice();
        return source.filter(item =>
            item.id.includes(query) ||
            item.local.toLowerCase().includes(q) ||
            (item.tipo || "").toLowerCase().includes(q)
        );
    }

    function renderTable(data, tab) {
        dataRowsContainer.innerHTML = "";

        if (!data || data.length === 0) {
            dataRowsContainer.innerHTML = '<div class="no-records">Nenhum registro encontrado nesta aba.</div>';
            recordCount.textContent = `00 Registros`;
            return;
        }

        data.forEach(item => {
            const row = document.createElement("div");
            row.classList.add("table-row", "transport-grid");

            let actionsHtml = '';
            let scColContent = `<span class="status-dot ${item.statusClass}"></span> ${item.id}`;
            let statusTextInSC = '';

            if (tab === 'pendente') {
                actionsHtml = `
                    <button class="action-btn green liberar-btn" data-id="${item.realId}">Liberar</button>
                    <button class="action-btn red bloquear-btn" data-id="${item.realId}">Bloquear</button>
                `;
            } else {
                if (item.status === 'Negado') {
                    actionsHtml = `<i class="fas fa-lock" title="Solicitação Bloqueada" style="font-size: 16px; color: var(--color-black-dot);"></i>`;
                    statusTextInSC = item.status;
                } else if (item.status === 'Aprovado') {
                    actionsHtml = `<i class="fas fa-check" title="Solicitação Liberada" style="font-size: 16px; color: var(--color-green-dot);"></i>`; 
                    if (item.motorista) {
                         statusTextInSC = `${item.status} (${item.motorista})`;
                    } else {
                         statusTextInSC = item.status;
                    }
                } else {
                    actionsHtml = `<i class="fas fa-history" title="Histórico" style="font-size: 16px; color: var(--light-text-color);"></i>`; 
                    statusTextInSC = item.status;
                }
                
                scColContent = `<span class="status-dot ${item.statusClass}"></span> ${item.id} <span class="status-detail">(${statusTextInSC})</span>`;
            }
            
            row.innerHTML = `
                <div class="col column-sc-number">${scColContent}</div>
                <div class="col column-local">${item.local}</div>
                <div class="col column-data">${item.data} - ${item.hora}</div>
                <div class="col column-tipo">${item.tipo}</div>
                <div class="col column-actions action-icons-group">${actionsHtml}</div>
            `;
            dataRowsContainer.appendChild(row);
        });

        recordCount.textContent = `${data.length.toString().padStart(2, "0")} Registros`;
    }

    function reloadCurrentTab() {
        const query = searchInput.value;
        const data = filterData(currentTab, query);
        renderTable(data, currentTab);
    }

    reloadCurrentTab();

    tabButtons.forEach(button => {
        button.addEventListener("click", () => {
            tabButtons.forEach(btn => btn.classList.remove("active"));
            button.classList.add("active");
            currentTab = button.getAttribute("data-tab");
            reloadCurrentTab();
            if (currentTab === "pendente" && pendingList.length === 0) loadPendingRequests();
            if (currentTab === "aprovado" && nonPendingList.length === 0) loadNonPendingRequests();
        });
    });

    searchInput.addEventListener("input", reloadCurrentTab);

    mainContent.insertAdjacentHTML('beforeend', `
        <div class="motorista-modal-overlay" id="motorista-modal-overlay" style="display:none;">
            <div class="motorista-modal-content" id="motorista-modal-content" style="display:none; position:absolute;">
                <div class="modal-header-custom">
                    <i class="fas fa-car"></i> SELECIONE O MOTORISTA
                </div>
                <ul class="motorista-list" id="motorista-list">
                    <li data-motorista="Motorista A (Plantão)">Motorista A (Plantão)</li>
                    <li data-motorista="Motorista B (Folga)">Motorista B (Folga)</li>
                    <li data-motorista="Motorista C (Em campo)">Motorista C (Em campo)</li>
                </ul>
            </div>
        </div>
    `);

    const motoristaModalOverlay = document.getElementById('motorista-modal-overlay');
    const motoristaModalContent = document.getElementById('motorista-modal-content');

    function showMotoristaModal(targetElement, scNumber) {
        const rect = targetElement.getBoundingClientRect();
        motoristaModalContent.setAttribute('data-sc-id', scNumber); 
        const top = Math.max(10, rect.top + window.scrollY + (rect.height / 2));
        const left = rect.left + rect.width + 10;
        motoristaModalContent.style.top = `${top}px`;
        motoristaModalContent.style.left = `${left}px`;
        motoristaModalOverlay.style.display = 'block'; 
        motoristaModalContent.style.display = 'block';
    }

    function hideMotoristaModal() {
        motoristaModalOverlay.style.display = 'none';
        motoristaModalContent.style.display = 'none';
    }

    dataRowsContainer.addEventListener("click", async (event) => {
        if (event.target.classList.contains("liberar-btn")) {
            const scNumber = event.target.getAttribute("data-id");
            showMotoristaModal(event.target, scNumber);
            event.stopPropagation();
            return;
        }

        if (event.target.classList.contains("bloquear-btn")) {
            const scNumber = Number(event.target.getAttribute("data-id"));
            try {
                const res = await fetch("http://localhost:5260/api/v1/TransportRequest/Deny", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ id: scNumber })
                });
                if (!res.ok) {
                    console.error("Erro ao negar:", res.status);
                    showStatusModal("bloquear", scNumber);
                } else {
                    await loadPendingRequests();
                    await loadNonPendingRequests();
                    showStatusModal("bloquear", scNumber);
                }
            } catch (err) {
                console.error("Erro ao chamar Deny:", err);
                showStatusModal("bloquear", scNumber);
            }
            return;
        }
    });

    motoristaModalContent.addEventListener("click", async (event) => {
        if (event.target.tagName !== 'LI') return;
        const motorista = event.target.getAttribute("data-motorista");
        const scNumber = Number(motoristaModalContent.getAttribute('data-sc-id'));
        if (!scNumber) { hideMotoristaModal(); return; }

        const body = {
            id: scNumber,
            vehicleId: 2,
            driverUserId: 6
        };

        try {
            const res = await fetch("http://localhost:5260/api/v1/TransportRequest/Accept", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                console.error("Erro Accept:", res.status);
                showStatusModal("liberar", scNumber, motorista);
            } else {
                await loadPendingRequests();
                await loadNonPendingRequests();
                showStatusModal("liberar", scNumber, motorista);
            }
        } catch (err) {
            console.error("Erro na Accept API:", err);
            showStatusModal("liberar", scNumber, motorista);
        } finally {
            hideMotoristaModal();
        }
    });

    motoristaModalOverlay.addEventListener("click", (event) => {
        if (event.target === motoristaModalOverlay) hideMotoristaModal();
    });


    const statusModal = document.getElementById("status-modal");
    const modalIconContainer = document.getElementById("modal-icon-container");
    const modalTextElement = document.getElementById("modal-text");
    const modalCloseButton = document.getElementById("modal-close");

    modalCloseButton.addEventListener('click', () => {
        statusModal.style.display = 'none';
    });

    function showStatusModal(type, scNumber, driverName = null) {
        modalIconContainer.innerHTML = "";
        statusModal.classList.remove("is-blocked");

        let iconHtml = "";
        let topLine = "";
        let code = String(scNumber).padStart(6, "0");
        let bottomLine = "";

        if (type === "liberar") {
            iconHtml = '<i class="fas fa-check success-icon"></i>';
            topLine = `Solicitação Nº`;
            bottomLine = `liberada para o motorista ${driverName || ""}!`;
        } else if (type === "bloquear") {
            statusModal.classList.add("is-blocked");
            iconHtml = '<i class="fas fa-times success-icon" style="color: var(--status-quebrado);"></i>';
            topLine = `Solicitação Nº`;
            bottomLine = `foi BLOQUEADA com sucesso!`;
        } else {
            iconHtml = '<i class="fas fa-info-circle success-icon"></i>';
            topLine = `Solicitação Nº`;
            bottomLine = ``;
        }

        modalIconContainer.innerHTML = iconHtml;
        modalTextElement.innerHTML = `${topLine} <span class="highlight-code">${code}</span><br>${bottomLine}`;

        statusModal.style.display = "flex";

        setTimeout(() => {
            statusModal.style.display = "none";
        }, 3000);
    }

    (async function init() {
        await Promise.all([loadPendingRequests(), loadNonPendingRequests()]);
        reloadCurrentTab();
    })();

    document.addEventListener("click", (e) => {
        if (motoristaModalOverlay.style.display === 'block' && !motoristaModalContent.contains(e.target)) {
            hideMotoristaModal();
        }
    });

});
</script>
</body>
</html>
